-- Script Auto Fly + Auto Attack (FIXED NO CLIP)
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local plr = Players.LocalPlayer
local flyActive = true
local targetPlayer = nil
local flyConnection = nil
local block = nil
local heightOffset = 5
local blacklist = {}
local healthCheckConnection = nil
local hopPending = false
local isRespawning = false

-- Biáº¿n cho auto attack vÃ  auto skills
_G.AutoAttack = true
_G.AttackPlayers = true
_G.RaceClickAutov4 = true
_G.SelectWeapon = nil
local Sec = 1 -- Delay cho Buso
local Boud = true -- Auto Buso

-- Táº¡o UI BÃªn TrÃ¡i
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FlyControlUI"
screenGui.Parent = CoreGui
screenGui.ResetOnSpawn = false

-- Container chÃ­nh (bÃªn trÃ¡i mÃ n hÃ¬nh)
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 280, 0, 220)
mainFrame.Position = UDim2.new(0, 10, 0.5, -110)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
mainFrame.BackgroundTransparency = 0.2
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 8)
corner.Parent = mainFrame

local title = Instance.new("TextLabel")
title.Name = "Title"
title.Size = UDim2.new(1, 0, 0, 35)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
title.BackgroundTransparency = 0.3
title.Text = "ğŸš€ AUTO FLY"
title.TextColor3 = Color3.fromRGB(0, 191, 255)
title.TextSize = 16
title.Font = Enum.Font.GothamBold
title.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 8)
titleCorner.Parent = title

local playerFrame = Instance.new("Frame")
playerFrame.Name = "PlayerFrame"
playerFrame.Size = UDim2.new(1, -20, 0, 50)
playerFrame.Position = UDim2.new(0, 10, 0, 45)
playerFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
playerFrame.BackgroundTransparency = 0.3
playerFrame.Parent = mainFrame

local playerCorner = Instance.new("UICorner")
playerCorner.CornerRadius = UDim.new(0, 6)
playerCorner.Parent = playerFrame

local targetIcon = Instance.new("ImageLabel")
targetIcon.Name = "TargetIcon"
targetIcon.Size = UDim2.new(0, 24, 0, 24)
targetIcon.Position = UDim2.new(0, 10, 0.5, -12)
targetIcon.BackgroundTransparency = 1
targetIcon.Image = "rbxassetid://3926305904"
targetIcon.ImageRectOffset = Vector2.new(964, 324)
targetIcon.ImageRectSize = Vector2.new(36, 36)
targetIcon.ImageColor3 = Color3.fromRGB(0, 191, 255)
targetIcon.Parent = playerFrame

local playerNameLabel = Instance.new("TextLabel")
playerNameLabel.Name = "PlayerName"
playerNameLabel.Size = UDim2.new(1, -50, 1, 0)
playerNameLabel.Position = UDim2.new(0, 40, 0, 0)
playerNameLabel.BackgroundTransparency = 1
playerNameLabel.Text = "Äang tÃ¬m target..."
playerNameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
playerNameLabel.TextSize = 14
playerNameLabel.Font = Enum.Font.Gotham
playerNameLabel.TextXAlignment = Enum.TextXAlignment.Left
playerNameLabel.Parent = playerFrame

local healthLabel = Instance.new("TextLabel")
healthLabel.Name = "HealthLabel"
healthLabel.Size = UDim2.new(1, -50, 0, 20)
healthLabel.Position = UDim2.new(0, 40, 0, 25)
healthLabel.BackgroundTransparency = 1
healthLabel.Text = "MÃ¡u: --"
healthLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
healthLabel.TextSize = 12
healthLabel.Font = Enum.Font.GothamMedium
healthLabel.TextXAlignment = Enum.TextXAlignment.Left
healthLabel.Parent = playerFrame

local buttonContainer = Instance.new("Frame")
buttonContainer.Name = "ButtonContainer"
buttonContainer.Size = UDim2.new(1, -20, 0, 110)
buttonContainer.Position = UDim2.new(0, 10, 0, 105)
buttonContainer.BackgroundTransparency = 1
buttonContainer.Parent = mainFrame

local function createButton(name, text, color, position)
    local btn = Instance.new("TextButton")
    btn.Name = name
    btn.Size = UDim2.new(1, 0, 0, 30)
    btn.Position = position
    btn.BackgroundColor3 = color
    btn.Text = text
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 14
    btn.Font = Enum.Font.GothamBold
    btn.Parent = buttonContainer
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = btn
    
    return btn
end

local blacklistBtn = createButton("BlacklistBtn", "â• ThÃªm Blacklist", Color3.fromRGB(255, 100, 100), UDim2.new(0, 0, 0, 0))
local hopBtn = createButton("HopBtn", "ğŸ”„ Hop Server", Color3.fromRGB(100, 100, 255), UDim2.new(0, 0, 0, 35))
local infoLabel = createButton("InfoLabel", "ğŸŸ¢ Auto: ON | âš”ï¸ Attack: ON", Color3.fromRGB(60, 60, 70), UDim2.new(0, 0, 0, 70))
infoLabel.Text = "ğŸŸ¢ Auto: ON | âš”ï¸ Attack: ON"
infoLabel.AutoButtonColor = false

-- ==================== FIXED NO CLIP SYSTEM ====================

local noclipConnection = nil
local originalCanCollide = {}

-- HÃ m báº­t noclip máº¡nh máº½ vÃ  á»•n Ä‘á»‹nh
function enableNoclip()
    if not plr.Character then return end
    
    -- Há»§y noclip cÅ© náº¿u cÃ³
    if noclipConnection then
        noclipConnection:Disconnect()
        noclipConnection = nil
    end
    
    -- XÃ³a BodyVelocity cÅ©
    local bodyVelocity = plr.Character:FindFirstChild("HumanoidRootPart"):FindFirstChild("BodyClip")
    if bodyVelocity then
        bodyVelocity:Destroy()
    end
    
    -- LÆ°u tráº¡ng thÃ¡i CanCollide gá»‘c vÃ  Ä‘áº·t thÃ nh false
    for _, part in pairs(plr.Character:GetDescendants()) do
        if part:IsA("BasePart") then
            originalCanCollide[part] = part.CanCollide
            part.CanCollide = false
        end
    end
    
    -- Táº¡o BodyVelocity má»›i
    local noclip = Instance.new("BodyVelocity")
    noclip.Name = "BodyClip"
    noclip.Parent = plr.Character.HumanoidRootPart
    noclip.MaxForce = Vector3.new(100000, 100000, 100000)
    noclip.Velocity = Vector3.new(0, 0, 0)
    
    -- Káº¿t ná»‘i Heartbeat Ä‘á»ƒ duy trÃ¬ noclip
    noclipConnection = RunService.Heartbeat:Connect(function()
        if not plr.Character or not flyActive then 
            if noclipConnection then
                noclipConnection:Disconnect()
            end
            return 
        end
        
        -- Äáº£m báº£o táº¥t cáº£ parts khÃ´ng thá»ƒ va cháº¡m
        for _, part in pairs(plr.Character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
        
        -- Äáº£m báº£o BodyVelocity tá»“n táº¡i
        if not plr.Character.HumanoidRootPart:FindFirstChild("BodyClip") then
            local newNoclip = Instance.new("BodyVelocity")
            newNoclip.Name = "BodyClip"
            newNoclip.Parent = plr.Character.HumanoidRootPart
            newNoclip.MaxForce = Vector3.new(100000, 100000, 100000)
            newNoclip.Velocity = Vector3.new(0, 0, 0)
        end
    end)
    
    print("âœ… Noclip Ä‘Ã£ Ä‘Æ°á»£c báº­t")
end

-- HÃ m táº¯t noclip
function disableNoclip()
    if noclipConnection then
        noclipConnection:Disconnect()
        noclipConnection = nil
    end
    
    if not plr.Character then return end
    
    -- XÃ³a BodyVelocity
    local bodyVelocity = plr.Character:FindFirstChild("HumanoidRootPart"):FindFirstChild("BodyClip")
    if bodyVelocity then
        bodyVelocity:Destroy()
    end
    
    -- KhÃ´i phá»¥c CanCollide
    for part, canCollide in pairs(originalCanCollide) do
        if part and part.Parent then
            part.CanCollide = canCollide
        end
    end
    originalCanCollide = {}
    
    print("âŒ Noclip Ä‘Ã£ táº¯t")
end

-- ==================== AUTO ATTACK FIXED FUNCTIONS ====================

-- HÃ m láº¥y táº¥t cáº£ má»¥c tiÃªu (bao gá»“m cáº£ quÃ¡i vÃ  ngÆ°á»i chÆ¡i)
local function getAllTargets(position, radius)
    local targets = {}
    
    -- TÃ¬m quÃ¡i váº­t trong Workspace
    local function findEnemiesInFolder(folderName)
        local folder = Workspace:FindFirstChild(folderName)
        if folder then
            for _, enemy in ipairs(folder:GetChildren()) do
                if enemy:IsA("Model") then
                    local humanoid = enemy:FindFirstChild("Humanoid")
                    local rootPart = enemy:FindFirstChild("HumanoidRootPart")
                    if humanoid and rootPart and humanoid.Health > 0 then
                        local distance = (rootPart.Position - position).Magnitude
                        if distance <= radius then
                            table.insert(targets, {Model = enemy, Type = "Mob"})
                        end
                    end
                end
            end
        end
    end
    
    -- TÃ¬m trong cÃ¡c folder cÃ³ thá»ƒ chá»©a quÃ¡i
    findEnemiesInFolder("Enemies")
    findEnemiesInFolder("_ENEMIES")
    findEnemiesInFolder("Mobs")
    findEnemiesInFolder("NPCs")
    
    -- TÃ¬m trá»±c tiáº¿p trong Workspace
    for _, enemy in ipairs(Workspace:GetChildren()) do
        if enemy:IsA("Model") and enemy.Name:lower():find("bandit") 
           or enemy.Name:lower():find("pirate") 
           or enemy.Name:lower():find("assassin") 
           or enemy.Name:lower():find("marine") then
            
            local humanoid = enemy:FindFirstChild("Humanoid")
            local rootPart = enemy:FindFirstChild("HumanoidRootPart")
            if humanoid and rootPart and humanoid.Health > 0 then
                local distance = (rootPart.Position - position).Magnitude
                if distance <= radius then
                    table.insert(targets, {Model = enemy, Type = "Mob"})
                end
            end
        end
    end
    
    -- Láº¥y ngÆ°á»i chÆ¡i khÃ¡c náº¿u Ä‘Æ°á»£c báº­t
    if _G.AttackPlayers then
        for _, otherPlayer in ipairs(Players:GetPlayers()) do
            if otherPlayer ~= plr and otherPlayer.Character then
                local character = otherPlayer.Character
                local humanoid = character:FindFirstChild("Humanoid")
                local rootPart = character:FindFirstChild("HumanoidRootPart")
                if humanoid and rootPart and humanoid.Health > 0 then
                    local distance = (rootPart.Position - position).Magnitude
                    if distance <= radius then
                        table.insert(targets, {Model = character, Type = "Player"})
                    end
                end
            end
        end
    end
    
    return targets
end

-- HÃ m táº¥n cÃ´ng Ä‘Æ¡n giáº£n (dÃ¹ng RemoteEvent)
local function simpleAttack(target)
    if not target or not target.Model then return end
    
    local character = plr.Character
    if not character then return end
    
    -- TÃ¬m weapon
    local weapon = character:FindFirstChildOfClass("Tool")
    if not weapon then
        -- Kiá»ƒm tra trong backpack
        if plr.Backpack then
            for _, tool in ipairs(plr.Backpack:GetChildren()) do
                if tool:IsA("Tool") then
                    weapon = tool
                    tool.Parent = character
                    wait(0.1)
                    break
                end
            end
        end
    end
    
    if not weapon then return end
    
    -- TÃ¬m remote Ä‘á»ƒ táº¥n cÃ´ng
    local function findAttackRemote()
        -- Thá»­ tÃ¬m trong ReplicatedStorage
        local modules = ReplicatedStorage:FindFirstChild("Modules")
        if modules then
            local net = modules:FindFirstChild("Net")
            if net then
                local registerAttack = net:FindFirstChild("RE/RegisterAttack")
                local registerHit = net:FindFirstChild("RE/RegisterHit")
                if registerAttack and registerHit then
                    return registerAttack, registerHit
                end
            end
        end
        
        -- Thá»­ tÃ¬m trá»±c tiáº¿p trong ReplicatedStorage
        local remotes = ReplicatedStorage:GetChildren()
        for _, remote in ipairs(remotes) do
            if remote:IsA("RemoteEvent") then
                if remote.Name:lower():find("attack") 
                   or remote.Name:lower():find("hit") 
                   or remote.Name:lower():find("damage") 
                   or remote.Name:lower():find("combat") then
                    return remote
                end
            end
        end
        
        return nil
    end
    
    -- Thá»±c hiá»‡n táº¥n cÃ´ng
    local attackRemote, hitRemote = findAttackRemote()
    if attackRemote and hitRemote then
        -- Fire registerAttack
        pcall(function()
            attackRemote:FireServer()
        end)
        
        -- Chá»n bá»™ pháº­n Ä‘á»ƒ táº¥n cÃ´ng
        local hitPart = target.Model:FindFirstChild("HumanoidRootPart") 
                       or target.Model:FindFirstChild("Head") 
                       or target.Model:FindFirstChild("Torso")
                       or target.Model.PrimaryPart
        
        if hitPart then
            pcall(function()
                -- Táº¡o hitTargets array
                local hitTargets = {{target.Model, hitPart}}
                hitRemote:FireServer(hitPart, hitTargets)
                
                -- Gá»­i click event Ä‘á»ƒ kÃ­ch hoáº¡t attack animation
                if weapon:FindFirstChild("Activated") then
                    weapon.Activated:Fire()
                end
                
                -- Fire click remote náº¿u cÃ³
                local clickRemote = weapon:FindFirstChild("ClickRemote") 
                                  or weapon:FindFirstChild("LeftClickRemote")
                                  or weapon:FindFirstChild("RightClickRemote")
                
                if clickRemote then
                    clickRemote:FireServer()
                end
            end)
        end
    elseif attackRemote then
        -- Náº¿u chá»‰ cÃ³ 1 remote
        pcall(function()
            attackRemote:FireServer(target.Model)
        end)
    end
    
    -- Thá»­ kÃ­ch hoáº¡t tool trá»±c tiáº¿p
    if weapon:FindFirstChild("Activated") then
        pcall(function()
            weapon.Activated:Fire()
        end)
    end
end

-- HÃ m kiá»ƒm tra vÃ  táº¥n cÃ´ng má»¥c tiÃªu
local function checkAndAttack()
    if not _G.AutoAttack then return end
    
    local character = plr.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end
    
    -- Láº¥y táº¥t cáº£ má»¥c tiÃªu trong bÃ¡n kÃ­nh 50 studs
    local targets = getAllTargets(rootPart.Position, 50)
    
    if #targets > 0 then
        -- Chá»n má»¥c tiÃªu gáº§n nháº¥t
        local nearestTarget = nil
        local nearestDistance = math.huge
        
        for _, target in ipairs(targets) do
            local targetRoot = target.Model:FindFirstChild("HumanoidRootPart")
            if targetRoot then
                local distance = (targetRoot.Position - rootPart.Position).Magnitude
                if distance < nearestDistance then
                    nearestDistance = distance
                    nearestTarget = target
                end
            end
        end
        
        if nearestTarget then
            -- Äáº£m báº£o Ä‘ang nhÃ¬n vá» má»¥c tiÃªu
            local targetRoot = nearestTarget.Model:FindFirstChild("HumanoidRootPart")
            if targetRoot then
                character:SetPrimaryPartCFrame(
                    CFrame.new(rootPart.Position, Vector3.new(
                        targetRoot.Position.X, 
                        rootPart.Position.Y, 
                        targetRoot.Position.Z
                    ))
                )
                
                -- Thá»±c hiá»‡n táº¥n cÃ´ng
                simpleAttack(nearestTarget)
                
                -- Log Ä‘á»ƒ debug
                print("âš”ï¸ Äang táº¥n cÃ´ng: " .. nearestTarget.Model.Name .. " (" .. nearestTarget.Type .. ")")
            end
        end
    end
end

-- ==================== FLY FUNCTIONS ====================

-- Táº¡o block áº£o cho tween
function createVirtualBlock()
    if block and block.Parent then 
        block:Destroy() 
    end
    
    block = Instance.new("Part")
    block.Name = "VirtualFlyBlock"
    block.Size = Vector3.new(1, 1, 1)
    block.Anchored = true
    block.CanCollide = false
    block.Transparency = 1
    block.Parent = workspace
    
    return block
end

-- TÃ¬m ngÆ°á»i chÆ¡i gáº§n nháº¥t khÃ´ng trong danh sÃ¡ch Ä‘en
function getNearestPlayer()
    local nearestPlayer = nil
    local nearestDistance = math.huge
    local localRoot = plr.Character and plr.Character:FindFirstChild("HumanoidRootPart")
    
    if not localRoot then return nil end
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= plr and not blacklist[player] then
            if player.Character then
                local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
                if targetRoot then
                    local humanoid = player.Character:FindFirstChild("Humanoid")
                    if humanoid and humanoid.Health > 0 then
                        local distance = (targetRoot.Position - localRoot.Position).Magnitude
                        if distance < nearestDistance then
                            nearestDistance = distance
                            nearestPlayer = player
                        end
                    else
                        blacklist[player] = true
                    end
                end
            end
        end
    end
    
    return nearestPlayer
end

-- Kiá»ƒm tra mÃ¡u cá»§a target player
function checkTargetHealth()
    if not targetPlayer or not targetPlayer.Character then
        return false
    end
    
    local humanoid = targetPlayer.Character:FindFirstChild("Humanoid")
    if not humanoid or humanoid.Health <= 0 then
        blacklist[targetPlayer] = true
        return false
    end
    
    return true
end

-- Báº­t highlight
function enableHighlight()
    if not plr.Character then return end
    
    if plr.Character:FindFirstChild("highlight") then
        plr.Character:FindFirstChild("highlight"):Destroy()
    end
    
    local highlight = Instance.new("Highlight")
    highlight.Name = "highlight"
    highlight.Enabled = true
    highlight.FillColor = Color3.fromRGB(0, 191, 255)
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0.2
    highlight.Parent = plr.Character
end

-- TÃ­nh toÃ¡n vá»‹ trÃ­ Ä‘á»©ng trÃªn Ä‘áº§u player
function getHeadPosition(targetPlayer)
    if not targetPlayer or not targetPlayer.Character then
        return nil
    end
    
    local character = targetPlayer.Character
    local head = character:FindFirstChild("Head")
    if head then
        return head.Position + Vector3.new(0, heightOffset, 0)
    end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if rootPart then
        return rootPart.Position + Vector3.new(0, 4 + heightOffset, 0)
    end
    
    return nil
end

-- HÃ m bay khÃ´ng delay - bÃ¡m sÃ¡t target vÃ  Ä‘á»©ng trÃªn Ä‘áº§u
function startFlying()
    if flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end
    
    if not block then
        block = createVirtualBlock()
    end
    
    local character = plr.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        return
    end
    
    local rootPart = character.HumanoidRootPart
    
    -- Äáº£m báº£o noclip Ä‘ang hoáº¡t Ä‘á»™ng trÆ°á»›c khi bay
    if not noclipConnection then
        enableNoclip()
    end
    
    -- Cáº­p nháº­t vá»‹ trÃ­ block theo real-time
    flyConnection = RunService.Heartbeat:Connect(function(deltaTime)
        if not flyActive or not targetPlayer or not targetPlayer.Character then
            return
        end
        
        if not checkTargetHealth() then
            local newTarget = getNearestPlayer()
            if newTarget then
                targetPlayer = newTarget
                updateUI()
            else
                return
            end
        end
        
        local targetRoot = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
        if not targetRoot then
            return
        end
        
        -- Äáº£m báº£o noclip luÃ´n hoáº¡t Ä‘á»™ng trong khi bay
        for _, part in pairs(character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
        
        local targetHeadPos = getHeadPosition(targetPlayer)
        if not targetHeadPos then
            targetHeadPos = targetRoot.Position + Vector3.new(0, heightOffset, 0)
        end
        
        local currentPos = rootPart.Position
        local direction = (targetHeadPos - currentPos).Unit
        local distance = (targetHeadPos - currentPos).Magnitude
        
        local speed = 300
        local moveDistance = math.min(speed * deltaTime, distance)
        
        if distance > 2 then
            local newPos = currentPos + (direction * moveDistance)
            local lookAtPos = Vector3.new(targetRoot.Position.X, newPos.Y, targetRoot.Position.Z)
            rootPart.CFrame = CFrame.new(newPos, lookAtPos)
            block.CFrame = rootPart.CFrame
        else
            local finalLookAt = Vector3.new(targetRoot.Position.X, targetHeadPos.Y, targetRoot.Position.Z)
            rootPart.CFrame = CFrame.new(targetHeadPos, finalLookAt)
            block.CFrame = rootPart.CFrame
        end
    end)
end

-- Dá»«ng bay
function stopFlying()
    flyActive = false
    
    if flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end
    
    if noclipConnection then
        disableNoclip()
    end
    
    print("âœˆï¸ ÄÃ£ dá»«ng bay")
end

-- Cáº­p nháº­t UI
function updateUI()
    if targetPlayer then
        playerNameLabel.Text = targetPlayer.Name
        if targetPlayer.Character then
            local humanoid = targetPlayer.Character:FindFirstChild("Humanoid")
            if humanoid then
                healthLabel.Text = "MÃ¡u: " .. math.floor(humanoid.Health) .. "/" .. math.floor(humanoid.MaxHealth)
            end
        end
    else
        playerNameLabel.Text = "Äang tÃ¬m target..."
        healthLabel.Text = "MÃ¡u: --"
    end
end

-- AUTO SKILLS FUNCTIONS ------------------------------------------------------

-- Tá»± Ä‘á»™ng trang bá»‹ Blox Fruit
local function equipBloxFruit()
    if plr.Backpack then
        for _, v in pairs(plr.Backpack:GetChildren()) do
            if v.ToolTip == "Blox Fruit" then
                if plr.Backpack:FindFirstChild(tostring(v.Name)) then
                    _G.SelectWeapon = v.Name
                    v.Parent = plr.Character
                    print("ğŸ‡ ÄÃ£ trang bá»‹ Blox Fruit: " .. v.Name)
                    break
                end
            end
        end
    end
end

-- Auto Buso Haki
local function autoBuso()
    pcall(function()
        if Boud then
            local _HasBuso = {"HasBuso", "Buso"}
            if not plr.Character:FindFirstChild(_HasBuso[1]) then
                ReplicatedStorage.Remotes.CommF_:InvokeServer(_HasBuso[2])
                print("ğŸ›¡ï¸ ÄÃ£ báº­t Buso Haki")
            end
        end
    end)
end

-- Auto Race V4
local function autoRaceV4()
    pcall(function()
        if _G.RaceClickAutov4 then
            if plr.Character:FindFirstChild("RaceEnergy") then
                if plr.Character:FindFirstChild("RaceEnergy").Value == 1 then
                    print("âš¡ ÄÃ£ kÃ­ch hoáº¡t Race V4")
                end
            end
        end
    end)
end

-- BUTTON FUNCTIONS -----------------------------------------------------------

blacklistBtn.MouseButton1Click:Connect(function()
    if targetPlayer then
        blacklist[targetPlayer] = true
        print("ğŸš« ÄÃ£ thÃªm " .. targetPlayer.Name .. " vÃ o blacklist")
        
        local newTarget = getNearestPlayer()
        if newTarget then
            targetPlayer = newTarget
            updateUI()
        else
            targetPlayer = nil
            updateUI()
        end
    end
end)

hopBtn.MouseButton1Click:Connect(function()
    print("ğŸ”„ Äang tÃ¬m server má»›i...")
    -- ThÃªm logic hop server á»Ÿ Ä‘Ã¢y
end)

-- Há»† THá»NG Há»’I SINH ---------------------------------------------------------

local function onCharacterAdded(character)
    isRespawning = true
    print("ğŸ”„ Äang há»“i sinh...")
    
    -- Chá» character load hoÃ n táº¥t
    wait(2)
    
    if flyActive then
        print("ğŸš€ Tiáº¿p tá»¥c bay sau khi há»“i sinh...")
        
        -- Báº­t láº¡i cÃ¡c hiá»‡u á»©ng
        enableNoclip()
        enableHighlight()
        
        -- TÃ¬m target má»›i
        local newTarget = getNearestPlayer()
        if newTarget then
            targetPlayer = newTarget
            updateUI()
        end
        
        -- Báº¯t Ä‘áº§u bay láº¡i
        startFlying()
        
        -- Trang bá»‹ tool vÃ  báº­t skills
        equipBloxFruit()
        
        isRespawning = false
        print("âœ… Há»“i sinh hoÃ n táº¥t, tiáº¿p tá»¥c bay!")
    end
end

local function onCharacterRemoving()
    print("ğŸ—‘ï¸ Character Ä‘ang bá»‹ xÃ³a...")
    if flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end
    if noclipConnection then
        disableNoclip()
    end
end

-- KHá»I Äá»˜NG SCRIPT ----------------------------------------------------------

local function startAutoFly()
    print("========================================")
    print("ğŸš€ AUTO FLY + ATTACK SCRIPT ÄANG KHá»I Äá»˜NG")
    print("========================================")
    
    if not plr.Character then
        print("â³ Äang chá» character...")
        plr.CharacterAdded:Wait()
    end
    wait(2)
    
    -- Báº­t cÃ¡c hiá»‡u á»©ng
    enableNoclip()
    enableHighlight()
    
    -- Trang bá»‹ Blox Fruit ngay khi vÃ o game
    equipBloxFruit()
    
    -- TÃ¬m target Ä‘áº§u tiÃªn
    targetPlayer = getNearestPlayer()
    
    if targetPlayer then
        print("ğŸ¯ ÄÃ£ tÃ¬m tháº¥y target: " .. targetPlayer.Name)
        updateUI()
        
        -- Báº¯t Ä‘áº§u bay
        startFlying()
        
        -- Theo dÃµi thay Ä‘á»•i target
        task.spawn(function()
            while flyActive do
                if not targetPlayer or blacklist[targetPlayer] then
                    local newTarget = getNearestPlayer()
                    if newTarget then
                        targetPlayer = newTarget
                        updateUI()
                        print("ğŸ”„ ÄÃ£ chuyá»ƒn sang target má»›i: " .. targetPlayer.Name)
                    end
                end
                wait(0.5)
            end
        end)
    end
    
    -- AUTO SKILLS LOOP
    task.spawn(function()
        while true do
            if plr.Character then
                autoBuso()
                autoRaceV4()
            end
            wait(Sec)
        end
    end)
    
    -- AUTO ATTACK LOOP (FIXED) - Sá»­ dá»¥ng Heartbeat Ä‘á»ƒ attack liÃªn tá»¥c
    task.spawn(function()
        while true do
            if _G.AutoAttack and plr.Character then
                pcall(function()
                    checkAndAttack()
                end)
            end
            wait(0.1) -- Giáº£m delay Ä‘á»ƒ attack nhanh hÆ¡n
        end
    end)
    
    print("âœ… Script Ä‘Ã£ khá»Ÿi Ä‘á»™ng thÃ nh cÃ´ng!")
    print("âš”ï¸ Auto Attack: " .. (_G.AutoAttack and "Báº¬T" or "Táº®T"))
    print("ğŸ¯ Attack Players: " .. (_G.AttackPlayers and "Báº¬T" or "Táº®T"))
    print("ğŸ›¡ï¸ Noclip: Báº¬T (á»•n Ä‘á»‹nh)")
end

-- Káº¾T Ná»I Sá»° KIá»†N -----------------------------------------------------------

-- Káº¿t ná»‘i sá»± kiá»‡n há»“i sinh
plr.CharacterAdded:Connect(onCharacterAdded)
plr.CharacterRemoving:Connect(onCharacterRemoving)

-- Káº¿t ná»‘i sá»± kiá»‡n Input Ä‘á»ƒ toggle noclip (phÃ­m N)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.N then
        if noclipConnection then
            disableNoclip()
        else
            enableNoclip()
        end
    end
end)

-- KHá»I CHáº Y CHÃNH -----------------------------------------------------------

task.spawn(function()
    startAutoFly()
end)

print("========================================")
print("ğŸ® AUTO FLY + ATTACK SCRIPT ÄÃƒ Sáº´N SÃ€NG")
print("========================================")
print("ğŸŒŸ TÃ­nh nÄƒng chÃ­nh:")
print("1. Tá»± Ä‘á»™ng bay Ä‘áº¿n player gáº§n nháº¥t")
print("2. Auto Attack quÃ¡i váº­t & player")
print("3. Auto trang bá»‹ Blox Fruit")
print("4. Auto Buso Haki")
print("5. Auto Race V4")
print("6. Tá»± Ä‘á»™ng há»“i sinh vÃ  tiáº¿p tá»¥c")
print("7. Noclip á»•n Ä‘á»‹nh (nháº¥n N Ä‘á»ƒ báº­t/táº¯t)")
print("========================================")
